#!/usr/bin/env bash

#============================================================
#
#         FileName: configure.sh
#
#      Descriptions:
#
#          Version: 1.0
#          Created: 2013-04-22 10:24:58
#         Revision: (none)
#
#           Author: xutao(Tony Xu), hhktony@gmail.com
#          Company: myself
#
#============================================================

ARCH=$(uname -m)
BACKUP_DATE=`date +%F`
FTP_NAME="ftp"
FTP_VUSERS_NAME="ftpvuser"
FTP_CONF_DIR="/etc/vsftpd"
FTP_ROOT_DIR="/var/$FTP_NAME"
FTP_VCONF_DIR="/etc/vsftpd/vusers_conf"
FTP_VCONF_FILE="/etc/vsftpd/.vusers"
FTP_VROOT_DIR="/var/$FTP_VUSERS_NAME"
PAM_CONF_DIR="/etc/pam.d"

help_info() {
  cat << EOF
usage: $0 [OPTIONS]

    help                                  Show this message
    init                                  Init config
    user-add <username> <passwd> <rw|r>   Add user
    user-list                             List user
EOF
}

msg() {
    printf '%b\n' "$1" >&2
}

error() {
    msg "\33[31m[✘]\33[0m ${1}${2}"
    exit 1
}

user_add() {
    local username=$1
    local passwd=$2
    local mode=$3

    if sed -n 'p;n' $FTP_VCONF_FILE | grep $username > /dev/null; then
        error "'$username' Already exist"
    fi

    echo $username >> $FTP_VCONF_FILE
    echo $passwd >> $FTP_VCONF_FILE

    if [ $mode == "rw" ]; then
        cp $FTP_VCONF_DIR/Templates/vuser_conf.r_w $FTP_VCONF_DIR/$username
    else
        cp $FTP_VCONF_DIR/Templates/vuser_conf.r   $FTP_VCONF_DIR/$unameser
    fi
    sed -i "s/vuser_name/${username}/" $FTP_VCONF_DIR/$username
    mkdir -p $FTP_VROOT_DIR/$username

    chown -R $FTP_VUSERS_NAME.$FTP_VUSERS_NAME $FTP_VROOT_DIR
    db_load -T -t hash -f $FTP_VCONF_FILE $FTP_CONF_DIR/vusers.db
}

user_list() {
    sed -n 'p;n' $FTP_VCONF_FILE # 取偶数行
}

init() {
    cp -r $FTP_CONF_DIR $FTP_CONF_DIR.$BACKUP_DATE.bak
    cp $PAM_CONF_DIR/vsftpd $PAM_CONF_DIR/vsftpd.bak
    rm -rf $FTP_CONF_DIR/*

    if [ $ARCH = 'x86_64' ]; then
        sed -i 's/%LIB%/lib64/' pam_vsftpd
    else
        sed -i 's/%LIB%/lib/' pam_vsftpd
    fi

    for name in `ls`
    do
        cp $name $FTP_CONF_DIR -r
    done

    mv $FTP_CONF_DIR/pam_vsftpd $PAM_CONF_DIR/vsftpd
    # rm $FTP_CONF_DIR/`basename $0` $FTP_CONF_DIR/README.md

    touch /var/log/vsftpd.log > /dev/zero 2>&1

    cd $FTP_CONF_DIR

    useradd $FTP_NAME -d $FTP_ROOT_DIR -s /sbin/nologin > /dev/zero 2>&1
    useradd $FTP_VUSERS_NAME -d $FTP_VROOT_DIR -s /sbin/nologin > /dev/zero 2>&1

    touch $FTP_VCONF_FILE
    db_load -T -t hash -f $FTP_VCONF_FILE $FTP_CONF_DIR/vusers.db
    chmod 600 $FTP_VCONF_FILE $FTP_CONF_DIR/vusers.db

    msg "\n-----------------> Configure over <-----------------\n\n
    1. Configuration file located in /etc/vsftpd/\n
    2. pam_vsftpd file located in /etc/pam.d/\n
    3. user dir in /var/ftpvuser/\n\n"
}

case $1 in
  --help|help|-h )
      help_info
      exit 0
      ;;
  init )
    init;;
  user-add )
    user_add $2 $3 $4;;
  user-list )
    user_list;;
  *)
    echo "unknown option: $1"
    help_info
    exit 1
    ;;
esac
